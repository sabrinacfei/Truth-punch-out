<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Truth PUNCH OUT!</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@500;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Noto Sans TC', sans-serif;
      text-align: center;
      padding: 30px;
      background: linear-gradient(to top, #e0f7fa, #ffffff);
    }
    h1 {
      font-size: 3em;
      color: #4a80ec;
      margin-bottom: 20px;
    }
    .card {
      max-width: 500px;
      margin: auto;
      background: #fff;
      border-radius: 20px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.1);
      padding: 30px;
    }
    input, textarea, button {
      margin: 10px 0;
      padding: 12px;
      width: 90%;
      border-radius: 10px;
      font-size: 1em;
      border: 1px solid #ccc;
    }
    button {
      background-color: #40a9ea;
      color: white;
      font-weight: bold;
      cursor: pointer;
      border: none;
      transition: transform 0.2s ease;
    }
    button:hover {
      transform: scale(1.05);
    }
    .output-box {
      background: #f8f9fa;
      padding: 10px;
      border-radius: 10px;
      margin-top: 10px;
      white-space: pre-wrap;
      text-align: left;
    }
    .avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
      margin-right: 10px;
      vertical-align: middle;
    }
    .comment {
      background: #ffeaea;
      padding: 6px 10px;
      margin-top: 6px;
      border-radius: 10px;
      text-align: left;
      font-size: 0.95em;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }
  </style>
</head>
<body>
  <h1>ğŸ® Truth PUNCH OUT!</h1>
  <div class="card">
    <h3>Step 1ï¼šè¼¸å…¥ä½ çš„å›°æ“¾</h3>
    <input type="text" id="lieInput" placeholder="è«‹è¼¸å…¥ä½ çš„å›°æ“¾ï¼Œä¾‹å¦‚ï¼šæˆ‘æ„Ÿåˆ°æ²’æœ‰åƒ¹å€¼...">
    <button id="searchButton">ğŸ“¨ å‚³é€</button>

    <h3>Step 2ï¼šçœŸç†ç¶“æ–‡ï¼ˆè‡ªå‹•æä¾›ï¼‰</h3>
    <div id="truthOutput" class="output-box">ğŸ“– ç­‰å¾…è¼¸å…¥ä½ çš„å›°æ“¾...</div>

    <h3>Step 3ï¼šæˆ‘å€‘ä¸€èµ·ä¾†ç¦±å‘Šï¼ˆè‡ªå‹•ç”¢ç”Ÿï¼‰</h3>
    <textarea id="prayerInput" placeholder="ç¦±å‘Šå…§å®¹æœƒè‡ªå‹•ç”Ÿæˆ..." rows="5"></textarea>

    <h3>Step 4ï¼šåˆ†äº«æ„Ÿå—æˆ–ç•™è¨€</h3>
    <textarea id="commentInput" placeholder="åˆ†äº«ä½ çš„æ„Ÿå—æˆ–ç•™è¨€...ï¼ˆå¯åŠ  emojiï¼‰" rows="2"></textarea>
    <button id="submitButton">âœ¨ æäº¤åˆ°å°çµ„ç‰†</button>

    <h3>ğŸ‘¥ å°çµ„åˆ†äº«ç‰†</h3>
    <div id="shareBoard"></div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
    import {getFirestore,collection,addDoc,getDoc,doc,updateDoc,query,orderBy,serverTimestamp,onSnapshot} from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";
  
    const firebaseConfig = {
      apiKey: "AIzaSyD-oI5ErPRkJkZK0hPo4Bfgav9YpK4iGYc",
      authDomain: "punch-out-bf304.firebaseapp.com",
      projectId: "punch-out-bf304",
      storageBucket: "punch-out-bf304.appspot.com",
      messagingSenderId: "930288317373",
      appId: "1:930288317373:web:25ceb302521f22b77018d4"
    };
  
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
  
    const playerInfo = JSON.parse(localStorage.getItem("playerInfo") || "null");
    if (!playerInfo) {
      alert("è«‹å…ˆé¸æ“‡è§’è‰²èˆ‡è¼¸å…¥åå­—ï¼");
      location.href = "index.html";
    }

    const userName = playerInfo.name;
    const userPhoto = playerInfo.photo;
    const userAvatar = playerInfo.avatar;

    const lieInput = document.getElementById("lieInput");
    const truthOutput = document.getElementById("truthOutput");
    const prayerInput = document.getElementById("prayerInput");
    const commentInput = document.getElementById("commentInput");
    const searchButton = document.getElementById("searchButton");
    const submitButton = document.getElementById("submitButton");
    const board = document.getElementById("shareBoard");

    searchButton.addEventListener("click", async () => {
      const lie = lieInput.value.trim();
      if (!lie) return;

      truthOutput.textContent = "ğŸ” æ­£åœ¨ç‚ºä½ å°‹æ‰¾çœŸç†ç¶“æ–‡...";
      prayerInput.value = "â³ æ­£åœ¨ç”¢ç”Ÿç¦±å‘Šæ–‡...";

      try {
        const res = await fetch("/api/search", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ text: lie })
        });
        const data = await res.json();
        truthOutput.textContent = "ğŸ“– " + (data.verse || "âš ï¸ æœªå–å¾—ç¶“æ–‡");
        prayerInput.value = data.prayer || "";
      } catch (err) {
        truthOutput.textContent = "âš ï¸ éŒ¯èª¤ï¼š" + err.message;
        prayerInput.value = "";
      }
    });

    submitButton.addEventListener("click", async () => {
      const lie = lieInput.value.trim();
      const truth = truthOutput.textContent.trim();
      const prayer = prayerInput.value.trim();
      const comment = commentInput.value.trim();
      if (!lie || !truth || !prayer) return alert("è«‹å¡«å¯«å®Œæ•´å…§å®¹");

      await addDoc(collection(db, "truthWall"), {
        user: userName,
        avatar: userAvatar,
        photo: userPhoto,
        lie, truth, prayer, comment,
        likes: 0,
        comments: [],
        timestamp: serverTimestamp()
      });
      lieInput.value = "";
      commentInput.value = "";
      truthOutput.textContent = "ğŸ“– ç­‰å¾…è¼¸å…¥ä½ çš„å›°æ“¾...";
      prayerInput.value = "";
    });

    const q = query(collection(db, "truthWall"), orderBy("timestamp", "desc"));
    onSnapshot(q, snapshot => {
      board.innerHTML = "";
      snapshot.forEach(docSnap => {
        const data = docSnap.data();
        const id = docSnap.id;
        const avatar = data.photo ? `<img src="${data.photo}" class="avatar">` : `<span class="avatar">${data.avatar || 'ğŸ‘¤'}</span>`;
        let commentsHtml = "";
        if (data.comments?.length) {
          data.comments.forEach((c, i) => {
            commentsHtml += `<div class='comment'><strong>${c.user}</strong>:${c.text} <button onclick="editComment('${id}', '${i}')">âœï¸</button> <button onclick="deleteComment('${id}',' ${i}')">ğŸ—‘ï¸</button></div>`;
          });
        }
        board.innerHTML += `
          <div class="output-box">
            <div style="display: flex; align-items: center; margin-bottom: 10px;">
              ${avatar}${data.user}æ‰“ç ´äº†å›°æ“¾ï¼š
            </div>
            <div style="margin-left: 10px;">
              <p>æœ¬ä¾†è¦ºå¾— ğŸ™ï¼šã€Œ${data.lie}ã€</p>
              <p>âœ¨ çœŸç†ç¶“æ–‡ï¼š${data.truth}</p>
              <p>ğŸ™ ç¦±å‘Šï¼š${data.prayer}</p>
              <p>ğŸ’¬ æ„Ÿå—ï¼š${data.comment || "ï¼ˆæœªå¡«å¯«ï¼‰"}</p>
            </div>
            <div style="display: flex; align-items: center; margin-top: 1px; gap: 1px;">
              <span style="font-size: 1.2em; cursor: pointer;" onclick="likePost('${id}')">ğŸ‘ <span style="color: black;">${data.likes}</span></span>
              <input id="comment-${id}" placeholder="è¼¸å…¥ç•™è¨€..." style="padding: 10px 14px; border-radius: 40px; border: 2px solid #ffd6d6; font-size: 1em; background-color: #fffafc;">
              <button onclick="submitComment('${id}')" style="padding: 8px 14px; border-radius: 10px; background-color: #fd79a8; color: white; border: none; font-weight: bold;">é€å‡º</button>
            </div>
            <div style="margin-top: 30px;">${commentsHtml}</div>
          </div>
        `;
      });
    });

    window.likePost = async id => {
      const liked = JSON.parse(localStorage.getItem("likedPosts") || "[]");
      if (liked.includes(id)) return alert("ä½ å·²ç¶“æŒ‰éè®šå›‰ï¼");
      const ref = doc(db, "truthWall", id);
      const snap = await getDoc(ref);
      if (snap.exists()) {
        await updateDoc(ref, { likes: snap.data().likes + 1 });
        liked.push(id);
        localStorage.setItem("likedPosts", JSON.stringify(liked));
      }
    };

    window.submitComment = async id => {
      const input = document.getElementById(`comment-${id}`);
      if (!playerInfo.name || !input.value) return;
      const ref = doc(db, "truthWall", id);
      const snap = await getDoc(ref);
      if (snap.exists()) {
        const updated = [...(snap.data().comments || []), { user: playerInfo.name, text: input.value }];
        await updateDoc(ref, { comments: updated });
        input.value = "";
      }
    };

    window.editComment = async (id, idx) => {
      const newText = prompt("è«‹è¼¸å…¥æ–°çš„ç•™è¨€å…§å®¹ï¼ˆå¯åŠ  emoji):");
      if (newText === null) return;
      const ref = doc(db, "truthWall", id);
      const snap = await getDoc(ref);
      if (snap.exists()) {
        const updated = snap.data().comments;
        updated[idx].text = newText;
        await updateDoc(ref, { comments: updated });
      }
    };

    window.deleteComment = async (id, idx) => {
      if (!confirm("ç¢ºå®šè¦åˆªé™¤é€™å‰‡ç•™è¨€å—ï¼Ÿ")) return;
      const ref = doc(db, "truthWall", id);
      const snap = await getDoc(ref);
      if (snap.exists()) {
        const updated = snap.data().comments;
        updated.splice(idx, 1);
        await updateDoc(ref, { comments: updated });
      }
    };
  </script>
</body>
</html>